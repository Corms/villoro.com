# --------------------------------------------------------------------------------------------------
# Basic metadata
# --------------------------------------------------------------------------------------------------
code: tables_format
title: Storing tables efficiently
date: "2019-03-21"
image: nginx_gunicorn_square.jpg
highlight: True

tags:
  - Python

tags_filter:
  - Python

# --------------------------------------------------------------------------------------------------
# Extra info. This will add a button with href to the url
# --------------------------------------------------------------------------------------------------
# link: 
#   text: 
#   url: 


# --------------------------------------------------------------------------------------------------
# Content
# --------------------------------------------------------------------------------------------------
brief_markdown: |
  Brief

# image_head:
#   filename: 
#   caption: 

use_chartjs: True

content_markdown: |

  When working with **pandas** people usually need to store one or more tables. There are a lot of different formats to do that. In this post I am going to compare the performance between them.

  ## How test will be done
  To do the tests I downloaded 3 datasets of different sizes:

  * [Small](https://www.kaggle.com/contactprad/bike-share-daily-data) (56 KB)
  * [Medium](https://www.kaggle.com/safegraph/visit-patterns-by-census-block-group) (233 MB)
  * [Large](https://www.kaggle.com/city-of-seattle/seattle-checkouts-by-title) (6.62 GB)

  I downloaded them from kaggle, one of the best places to find datasets.

  The formats that I will test are:

  * csv
  * feather
  * msgpack
  * parquet
  * pickle
  * xlsx

  ## Test 1: Simple test
  First of all I will check how they perform without changing any parameters. I will do 100 iterations with the small dataset and 10 with the medium one.

  ### Size small and iterations 100 with all extensions

  First of all the average reading/writing times for each format.

  <canvas id="chart_s0_i100_time" style="width:100%;height:300px;"></canvas>

  > It seems that `xlsx` is a slow option

  ### Size medium and iterations 10 with all extensions

  <canvas id="chart_s1_i10_time" style="width:100%;height:300px;"></canvas>

  With the medium dataframe the results are very similar.

  > `xlsx` is a slow solution. I would only recommend it for small dataframes.

  <canvas id="chart_s1_i10_size" style="width:100%;height:300px;"></canvas>

  Regarding the file size both `xlsx` and `parquet` outperform the rest. If you look the pandas documentation you will see that **all extensions except `xlsx` and `feather` allow different types of compression.** Also `parquet` uses a more agresive compression by default. We need to test the formats and the different compressions.

  ## Test 2: Include compressions

  <canvas id="chart_s1_i5_time" style="width:100%;height:300px;"></canvas>
  <canvas id="chart_s1_i5_size" style="width:100%;height:300px;"></canvas>

  <canvas id="chart_s1_i5_scatter_read" style="width:100%;height:300px;"></canvas>
  <canvas id="chart_s1_i5_scatter_write" style="width:100%;height:300px;"></canvas>



scripts: |
  <script>
    var chart_s0_i100_time = new Chart("chart_s0_i100_time", {
      type: 'bar',
      data: {
        labels: ['csv', 'feather', 'msgpack', 'parquet', 'pickle', 'xlsx'],
        datasets: [
          {
            label: 'read',
            backgroundColor: "#64B5F6", 
            data: [0.005766, 0.002291, 0.001909, 0.004744, 0.002504, 0.121258],
          },
          {
            label: 'write',
            backgroundColor: "#FFA726",
            data: [0.027968, 0.006942, 0.005825, 0.008368, 0.007167, 0.221087],
          }
        ],
      },
      options: {
        title: {
          display: true,
          text: 'Read/write average time [s] with small dataframe (56 KB)'
        },
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Time [seconds]'
            }
          }]
        }
      }
    });

    var chart_s1_i10_time = new Chart("chart_s1_i10_time", {
      type: 'bar',
      data: {
        labels: ['csv', 'feather', 'msgpack', 'parquet', 'pickle', 'xlsx'],
        datasets: [
          {
            label: 'read',
            backgroundColor: "#64B5F6", 
            data: [3.355233, 0.672547, 0.644967, 0.974831, 0.581298, 39.258066],
          },
          {
            label: 'write',
            backgroundColor: "#FFA726",
            data: [6.443962, 1.004818, 1.486842, 1.969526, 1.476743, 95.992012],
          }
        ],
      },
      options: {
        title: {
          display: true,
          text: 'Read/write average time [s] with medium dataframe (233 MB)'
        },
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Time [seconds]'
            }
          }]
        }
      }
    });
    var chart_s1_i10_size = new Chart("chart_s1_i10_size", {
      type: 'bar',
      data: {
        labels: ['csv', 'feather', 'msgpack', 'parquet', 'pickle', 'xlsx'],
        datasets: [
          {
            label: 'file size',
            backgroundColor: "#64B5F6", 
            data: [236.1, 213.38, 210.09, 96.37, 207.54, 68.21],
          },
        ],
      },
      options: {
        title: {
          display: true,
          text: 'File size with medium dataframe (233 MB)'
        },
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'File size [MB]'
            }
          }]
        }
      }
    });

    var chart_s1_i5_time = new Chart("chart_s1_i5_time", {
      type: 'bar',
      data: {
        labels: [
          'csv_None', 'csv_bz2', 'csv_gzip', 'csv_infer', 'csv_xz', 'csv_zip',
          'feather', 'msgpack_None', 'msgpack_blosc', 'msgpack_zlib',
          'parquet_None', 'parquet_brotli', 'parquet_gzip', 'parquet_snappy',
          'pickle_None', 'pickle_bz2', 'pickle_gzip', 'pickle_infer', 'pickle_xz',
          'pickle_zip'
        ],
        datasets: [
          {
            label: 'read',
            backgroundColor: "#64B5F6", 
            data: [3.052051, 10.516266, 4.25702, 3.094328, 9.920079, 4.052968, 0.60659, 0.493087, 0.476919, 0.51484, 0.766749, 0.98578, 0.996152, 0.809635, 0.465547, 7.775791, 1.48881, 0.476745, 6.258862, 2.065088],
          },
          {
            label: 'write',
            backgroundColor: "#FFA726",
            data: [5.898017, 24.439828, 49.018689, 6.003964, 288.619755, 21.263131, 0.99833, 1.324669, 1.367148, 2.049314, 1.411415, 27.043478, 18.282706, 1.868614, 1.339422, 18.5083, 40.682403, 1.368525, 254.315614, 17.856649],
          }
        ],
      },
      options: {
        title: {
          display: true,
          text: 'Read/write average time [s] with medium dataframe (233 MB)'
        },
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Time [seconds]'
            }
          }]
        }
      }
    });
    var chart_s1_i5_size = new Chart("chart_s1_i5_size", {
      type: 'bar',
      data: {
        labels: [
          'csv_None', 'csv_bz2', 'csv_gzip', 'csv_infer', 'csv_xz', 'csv_zip',
          'feather', 'msgpack_None', 'msgpack_blosc', 'msgpack_zlib',
          'parquet_None', 'parquet_brotli', 'parquet_gzip', 'parquet_snappy',
          'pickle_None', 'pickle_bz2', 'pickle_gzip', 'pickle_infer', 'pickle_xz',
          'pickle_zip'
        ],
        datasets: [
          {
            label: 'file size',
            backgroundColor: "#64B5F6", 
            data: [236.1, 47.58, 65.8, 236.1, 43.99, 66.44, 213.38, 210.09, 202.88, 202.9, 209.58, 50.82, 56.75, 96.37, 207.54, 40.93, 54.85, 207.54, 38.05, 55.43],
          },
        ],
      },
      options: {
        title: {
          display: true,
          text: 'File size with medium dataframe (233 MB)'
        },
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'File size [MB]'
            }
          }]
        }
      }
    });
    var chart_s1_i5_scatter_read = new Chart("chart_s1_i5_scatter_read", {
      type: 'scatter',
      data: {
        labels: [
          'csv_None', 'csv_bz2', 'csv_gzip', 'csv_infer', 'csv_xz', 'csv_zip',
          'feather', 'msgpack_None', 'msgpack_blosc', 'msgpack_zlib',
          'parquet_None', 'parquet_brotli', 'parquet_gzip', 'parquet_snappy',
          'pickle_None', 'pickle_bz2', 'pickle_gzip', 'pickle_infer', 'pickle_xz',
          'pickle_zip'
        ],
        datasets: [
          {
            label: 'read',
            backgroundColor: "#64B5F6", 
            data: [
              {'x': 3.052051, 'y': 236.1},
              {'x': 10.516266, 'y': 47.58},
              {'x': 4.25702, 'y': 65.8},
              {'x': 3.094328, 'y': 236.1},
              {'x': 9.920079, 'y': 43.99},
              {'x': 4.052968, 'y': 66.44},
              {'x': 0.60659, 'y': 213.38},
              {'x': 0.493087, 'y': 210.09},
              {'x': 0.476919, 'y': 202.88},
              {'x': 0.51484, 'y': 202.9},
              {'x': 0.766749, 'y': 209.58},
              {'x': 0.98578, 'y': 50.82},
              {'x': 0.996152, 'y': 56.75},
              {'x': 0.809635, 'y': 96.37},
              {'x': 0.465547, 'y': 207.54},
              {'x': 7.775791, 'y': 40.93},
              {'x': 1.48881, 'y': 54.85},
              {'x': 0.476745, 'y': 207.54},
              {'x': 6.258862, 'y': 38.05},
              {'x': 2.065088, 'y': 55.43}
            ],
          },
        ],
      },
      options: {
        title: {
          display: true,
          text: 'Average reading time vs file size'
        },
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'File size [MB]'
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Read average time [s]'
            }
          }]
        }
      }
    });
    var chart_s1_i5_scatter_write = new Chart("chart_s1_i5_scatter_write", {
      type: 'scatter',
      data: {
        labels: [
          'csv_None', 'csv_bz2', 'csv_gzip', 'csv_infer', 'csv_xz', 'csv_zip',
          'feather', 'msgpack_None', 'msgpack_blosc', 'msgpack_zlib',
          'parquet_None', 'parquet_brotli', 'parquet_gzip', 'parquet_snappy',
          'pickle_None', 'pickle_bz2', 'pickle_gzip', 'pickle_infer', 'pickle_xz',
          'pickle_zip'
        ],
        datasets: [
          {
            label: 'write',
            backgroundColor: "#FFA726", 
            data: [
              {'x': 3.052051, 'y': 236.1},
              {'x': 10.516266, 'y': 47.58},
              {'x': 4.25702, 'y': 65.8},
              {'x': 3.094328, 'y': 236.1},
              {'x': 9.920079, 'y': 43.99},
              {'x': 4.052968, 'y': 66.44},
              {'x': 0.60659, 'y': 213.38},
              {'x': 0.493087, 'y': 210.09},
              {'x': 0.476919, 'y': 202.88},
              {'x': 0.51484, 'y': 202.9},
              {'x': 0.766749, 'y': 209.58},
              {'x': 0.98578, 'y': 50.82},
              {'x': 0.996152, 'y': 56.75},
              {'x': 0.809635, 'y': 96.37},
              {'x': 0.465547, 'y': 207.54},
              {'x': 7.775791, 'y': 40.93},
              {'x': 1.48881, 'y': 54.85},
              {'x': 0.476745, 'y': 207.54},
              {'x': 6.258862, 'y': 38.05},
              {'x': 2.065088, 'y': 55.43}
            ],
          },
        ],
      },
      options: {
        title: {
          display: true,
          text: 'Average writting time vs file size'
        },
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'File size [MB]'
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Write average time [s]'
            }
          }]
        }
      }
    });
  </script>
  